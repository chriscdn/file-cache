var e=require("path"),t=require("fs"),r=require("path-exists"),i=require("sha1"),n=require("@chriscdn/promise-semaphore"),s=require("touch"),o=require("@chriscdn/find-nuke"),a=require("@chriscdn/duration"),h=require("rimraf");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=/*#__PURE__*/u(e),c=/*#__PURE__*/u(i),v=/*#__PURE__*/u(n),f=/*#__PURE__*/u(s);function m(e,t){try{var r=e()}catch(e){return t(!0,e)}return r&&r.then?r.then(t.bind(null,!1),t.bind(null,!0)):t(!1,r)}exports.FileCache=/*#__PURE__*/function(){function e(e){var t=e.cachePath,i=e.resolveFileName,n=e.cb,s=e.ext,o=e.ttl,h=e.cleanupInterval;this._cachePath=void 0,this._resolveFileName=void 0,this._cb=void 0,this._ext=void 0,this._ttl=void 0,this._cleanupInterval=void 0,this._intervalId=null,this._semaphore=new v.default,this._cleanupSemaphore=new v.default,this._cachePath=t,this._resolveFileName=i,this._cb=n,this._ext=s,this._ttl=o,this._cleanupInterval=null!=h?h:a.Duration.toMilliseconds({days:1});try{return Promise.resolve(r.pathExists(this._cachePath)).then(function(e){if(!e)throw new Error("ðŸ’¥ FileCache error: cachePath does not exist.")})}catch(e){Promise.reject(e)}this.cleanup(),this._intervalId=setInterval(this.cleanup.bind(this),this._cleanupInterval)}var i=e.prototype;return i.cleanup=function(){try{var e=this,t=m(function(){return Promise.resolve(e._cleanupSemaphore.acquire()).then(function(){return Promise.resolve(o.findNuke(e._cachePath,{olderThan:e._ttl,verbose:!0,deleteEmptyDirectories:!0})).then(function(){})})},function(t,r){if(e._cleanupSemaphore.release(),t)throw r;return r});return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},i.getFile=function(e){try{var i=this,n=i.resolveFilePath(e),s=m(function(){return Promise.resolve(Promise.all([i._semaphore.acquire(n),i._cleanupSemaphore.wait()])).then(function(){return Promise.resolve(r.pathExists(n)).then(function(r){var s=function(){if(!r)return Promise.resolve(t.promises.mkdir(l.default.dirname(n),{recursive:!0})).then(function(){return Promise.resolve(i._cb(n,e)).then(function(){})});f.default(n)}();if(s&&s.then)return s.then(function(){})})})},function(e,t){if(i._semaphore.release(n),e)throw t;return t});return Promise.resolve(s&&s.then?s.then(function(){return n}):n)}catch(e){return Promise.reject(e)}},i.expire=function(e){try{var t=this.resolveFilePath(e);return Promise.resolve(r.pathExists(t)).then(function(e){return!!e&&Promise.resolve(h.rimraf(t)).then(function(){return!0})})}catch(e){return Promise.reject(e)}},i.destroy=function(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null)},i.resolveFileName=function(e){return this._resolveFileName?this._resolveFileName(e):c.default(JSON.stringify(e,Object.keys(e).sort()))+"."+this._ext},i.resolveFilePath=function(e){var t=this.resolveFileName(e);return l.default.resolve(this._cachePath,t[0],t[1],t[2],t[3],t)},e}();
//# sourceMappingURL=file-cache.cjs.map
