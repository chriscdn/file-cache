import e from"path";import{promises as t}from"fs";import{pathExists as r}from"path-exists";import i from"sha1";import n from"@chriscdn/promise-semaphore";import o from"touch";import{findNuke as s}from"@chriscdn/find-nuke";import{Duration as h}from"@chriscdn/duration";import{rimraf as a}from"rimraf";function c(e,t){try{var r=e()}catch(e){return t(!0,e)}return r&&r.then?r.then(t.bind(null,!1),t.bind(null,!0)):t(!1,r)}var l=/*#__PURE__*/function(){function l(e){var t=e.cachePath,i=e.resolveFileName,o=e.cb,s=e.ext,a=e.ttl,c=e.cleanupInterval;this._cachePath=void 0,this._resolveFileName=void 0,this._cb=void 0,this._ext=void 0,this._ttl=void 0,this._cleanupInterval=void 0,this._intervalId=null,this._semaphore=new n,this._cleanupSemaphore=new n,this._cachePath=t,this._resolveFileName=i,this._cb=o,this._ext=s,this._ttl=a,this._cleanupInterval=null!=c?c:h.toMilliseconds({days:1});try{return Promise.resolve(r(this._cachePath)).then(function(e){if(!e)throw new Error("ðŸ’¥ FileCache error: cachePath does not exist.")})}catch(e){Promise.reject(e)}this.cleanup(),this._intervalId=setInterval(this.cleanup.bind(this),this._cleanupInterval)}var u=l.prototype;return u.cleanup=function(){try{var e=this,t=c(function(){return Promise.resolve(e._cleanupSemaphore.acquire()).then(function(){return Promise.resolve(s(e._cachePath,{olderThan:e._ttl,verbose:!0,deleteEmptyDirectories:!0})).then(function(){})})},function(t,r){if(e._cleanupSemaphore.release(),t)throw r;return r});return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},u.getFile=function(i){try{var n=this,s=n.resolveFilePath(i),h=c(function(){return Promise.resolve(Promise.all([n._semaphore.acquire(s),n._cleanupSemaphore.wait()])).then(function(){return Promise.resolve(r(s)).then(function(r){var h=function(){if(!r)return Promise.resolve(t.mkdir(e.dirname(s),{recursive:!0})).then(function(){return Promise.resolve(n._cb(s,i)).then(function(){})});o(s)}();if(h&&h.then)return h.then(function(){})})})},function(e,t){if(n._semaphore.release(s),e)throw t;return t});return Promise.resolve(h&&h.then?h.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},u.expire=function(e){try{var t=this.resolveFilePath(e);return Promise.resolve(r(t)).then(function(e){return!!e&&Promise.resolve(a(t)).then(function(){return!0})})}catch(e){return Promise.reject(e)}},u.destroy=function(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null)},u.resolveFileName=function(e){return this._resolveFileName?this._resolveFileName(e):i(JSON.stringify(e,Object.keys(e).sort()))+"."+this._ext},u.resolveFilePath=function(t){var r=this.resolveFileName(t);return e.resolve(this._cachePath,r[0],r[1],r[2],r[3],r)},l}();export{l as FileCache};
//# sourceMappingURL=file-cache.module.js.map
